<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Hahamirror : haha mirror effect with javascript" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Hahamirror</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/ajccom/hahaMirror">View on GitHub</a>

          <h1 id="project_title">Hahamirror</h1>
          <h2 id="project_tagline">haha mirror effect with javascript</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/ajccom/hahaMirror/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/ajccom/hahaMirror/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="hahamirror" class="anchor" href="#hahamirror"><span class="octicon octicon-link"></span></a>hahaMirror</h1>

<p>"HaHa" mirror effect with javascript.</p>

<h3>
<a name="functions" class="anchor" href="#functions"><span class="octicon octicon-link"></span></a>functions</h3>

<h4>
<a name="appto" class="anchor" href="#appto"><span class="octicon octicon-link"></span></a>app.to</h4>

<p>I want to use it to soft to image, but it's not nice;</p>

<p>Perhaps I should use the "Gaussian filter".</p>

<h4>
<a name="appzoom" class="anchor" href="#appzoom"><span class="octicon octicon-link"></span></a>app.zoom</h4>

<p>just zoom your image in an area.</p>

<h4>
<a name="apphahamirror" class="anchor" href="#apphahamirror"><span class="octicon octicon-link"></span></a>app.hahaMirror</h4>

<p>Yes, this function can generate the "HaHa" mirror effect.</p>

<h3>
<a name="in-chrome-you-should-run-it-on-a-web-service" class="anchor" href="#in-chrome-you-should-run-it-on-a-web-service"><span class="octicon octicon-link"></span></a>In Chrome, you should run it on a web service.</h3>
      </section>
      <section style="width: 800px; margin: 0 auto; padding: 20px 0">
        <style>
        #canvas:hover {cursor: none}
        </style>
        <canvas id="canvas" width="200" height="200" ></canvas>
        <canvas id="canvas2" width="200" height="200" ></canvas>
        <script>
          "use strict"
          void function (isDebug) {
            var app = {
              setImg: function (src) {
                if (!src) {return}
                this.ctx = document.getElementById('canvas').getContext('2d');
                
                var img = new Image();
                img.onload = function () {
                  document.getElementById('canvas2').getContext('2d').drawImage(img, 0, 0);
                  app.ctx.drawImage(img, 0, 0);
                  app.data = app.ctx.getImageData(0, 0, app.w, app.h);
                  app.draw();
                }
                img.src = src;
              },
              draw: function () {
                //柔光
                //this.to();
                
                //光源
                //
                
                //放大镜
                //this.zoom(100, 100, 50, 1.5);
                
                //哈哈镜
                this.hahaMirror(100, 100, 80);
              },
              hahaMirror: function (centerX, centerY, radius) {
                var d = this.data.data,
                    cc = document.getElementById('canvas2').getContext('2d').getImageData(0, 0, this.w, this.h),
                    copy = cc.data,
                    zoom = 1,
                    i = 0,
                    l = this.w * this.h,
                    x = 0,
                    y = 0,
                    temp = 0,
                    realRadius = parseInt(radius / zoom, 10),
                    distance = 0;
                this.ctx.putImageData(cc, 0, 0);
                this.data = app.ctx.getImageData(0, 0, app.w, app.h);
                d = this.data.data;
                for (i; i < l; i++) {
                  x = i % this.w;
                  y = parseInt(i / this.w, 10);
                  distance = Math.sqrt((x - centerX) * (x - centerX) + (y - centerY) * (y - centerY));
                  if (distance <= radius) {
                    x = parseInt((x - centerX) / zoom, 10);
                    y = parseInt((y - centerY) / zoom, 10);
                    //开天眼算法。。。
                    //x = parseInt(x * (realRadius /(radius - distance)), 10) + centerX;
                    //y = parseInt(y * (realRadius /(radius - distance)), 10) + centerY;
                    
                    //放大镜算法
                    x = parseInt(x * (distance / realRadius), 10) + centerX;
                    y = parseInt(y * (distance / realRadius), 10) + centerY;
                    
                    
                    temp = (y * this.w + x) * 4;
                    d[i * 4] = copy[temp];
                    d[i * 4 + 1] = copy[temp + 1];
                    d[i * 4 + 2] = copy[temp + 2];
                    
                  }
                }
                
                this.ctx.putImageData(this.data, 0, 0);
              },
              zoom: function (centerX, centerY, radius, zoom) {
                var d = this.data.data,
                    copy = this.ctx.getImageData(0, 0, this.w, this.h).data,
                    i = 0,
                    l = this.w * this.h,
                    x = 0,
                    y = 0,
                    temp = 0;
                
                for (i; i < l; i++) {
                  x = i % this.w;
                  y = parseInt(i / this.w, 10);
                  if ((x - centerX) * (x - centerX) + (y - centerY) * (y - centerY) <= radius * radius) {
                    x = parseInt((x - centerX) / zoom + centerX, 10);
                    y = parseInt((y - centerY) / zoom + centerY, 10);
                    temp = (y * this.w + x) * 4;
                    d[i * 4] = copy[temp];
                    d[i * 4 + 1] = copy[temp + 1];
                    d[i * 4 + 2] = copy[temp + 2];
                  }
                }
                
                this.ctx.putImageData(this.data, 0, 0);
              },
              to: function () {
                
                //var ctx = this.tempCanvas.getContext('2d');
                
                //柔光
                var data = app.data.data,
                    //d = data.slice(0),
                    i = 0,
                    l = this.w * this.h,
                    temp = 0;
                for (i; i < l; i++) {
                  temp = getAverage(i);
                  data[4 * i] = temp[0];
                  data[4 * i + 1] = temp[1];
                  data[4 * i + 2] = temp[2];
                }
                this.ctx.putImageData(this.data, 0, 0);
                
                function getAverage (idx) {
                  var d = app.data.data,
                      w = app.w,
                      h = app.h,
                      c = 0,
                      n = 0,
                      r = 0,
                      g = 0,
                      b = 0;
                  // l t
                  c = (idx - w - 1) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // m t
                  c = (idx - w) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // r t
                  c = (idx - w + 1) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // l m
                  c = (idx - 1) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // m m
                  c = idx * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // r m
                  c = (idx + 1) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // l b
                  c = (idx + w - 1) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // m b
                  c = (idx + w) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  // r b
                  c = (idx + w + 1) * 4;
                  if (d[c] >= 0) {
                     n++;
                     r += d[c];
                     g += d[c + 1];
                     b += d[c + 2];
                  }
                  
                  r = r / n;
                  g = g / n;
                  b = b / n;
                  return [r, g, b];
                }
                
              },
              _ini: function () {
                this.w = 200;
                this.h = 200;
                var c = document.createElement('canvas');
                c.width = this.w;
                c.height = this.h;
                this.tempCanvas = c;
              },
              ini: function (src) {
                this._ini();
                this.setImg(src);
                this.play();
              },
              play: function () {
                var c = document.getElementById('canvas');
                c.addEventListener('mousemove', function (e) {
                  app.e = e || window.event;
                  app.isOk = 1;
                });
                c.addEventListener('mouseup', function () {
                  app.isOk = 0;
                });
                setInterval(function () {
                  if (app.isOk) {
                    var x = Math.max(document.body.scrollTop, document.documentElement.scrollTop) + app.e.clientX - c.offsetLeft,
                        y = Math.max(document.body.scrollTop, document.documentElement.scrollTop) + app.e.clientY - c.offsetTop;
                    app.hahaMirror(x, y, 80, 1);
                  }
                }, 25);
              }
            };
            
            app.ini('ooo2.jpg');
            
            window.app = app;

          }(false);
        </script>
        <p>touch the left picture.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Hahamirror maintained by <a href="https://github.com/ajccom">ajccom</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
